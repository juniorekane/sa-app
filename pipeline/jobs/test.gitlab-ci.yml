unit-tests:
  stage: test
  image: $MVN_DEFAULT_IMAGE
  needs:
    - job: build
      artifacts: true
  script:
    - mvn $MAVEN_CLI_OPTS clean test jacoco:report
    - |
      awk -F"," '
        FNR > 1 { instructions += $4 + $5; covered += $5 }
        END { printf "Coverage: %.2f%%\n", 100*covered/instructions }
      ' */target/site/jacoco/jacoco.csv || echo "Coverage: 0%"
  artifacts:
    when: always
    reports:
      junit:
        - "**/target/surefire-reports/*.xml"
      coverage_report:
        coverage_format: jacoco
        path: "**/target/site/jacoco/jacoco.xml"
    paths:
      - "**/target/site/jacoco/jacoco.xml"
      - "**/target/surefire-reports/*.xml"
  coverage: '/Coverage: \d+\.?\d*%/'

integration-tests:
  stage: test
  image: $MVN_DEFAULT_IMAGE
  needs:
    - job: build
      artifacts: true
      optional: true
  script:
    - mvn $MAVEN_CLI_OPTS verify -DskipUnitTests
  artifacts:
    when: always
    reports:
      junit:
        - "**/target/failsafe-reports/*.xml"
  rules:
    - when: manual
      allow_failure: true