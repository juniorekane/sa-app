variables:
  DOCKER_BUILD_IMAGE: "docker:latest"
  TRIVY_IMAGE: "aquasec/trivy:latest"
  MAVEN_OPTS: "-Djava.net.preferIPv4Stack=true -Djava.net.preferIPv6Addresses=false"

.docker-build-base:
  stage: package
  image: $MVN_DEFAULT_IMAGE
  needs:
    - job: build
      artifacts: true
    - job: unit-tests
      artifacts: false
    - job: dependency-scan
      artifacts: false

build-docker-api:
  extends: .docker-build-base
  stage: package
  script:
    - echo "$CI_REGISTRY_IMAGE"
    - mvn $MAVEN_CLI_OPTS $MAVEN_OPTS package jib:build -DskipTests
      -pl sa-app-api
      -Djib.to.image=$CI_REGISTRY_IMAGE/api:$CI_COMMIT_SHA
      -Djib.to.auth.username=$CI_REGISTRY_USER
      -Djib.to.auth.password=$CI_REGISTRY_PASSWORD
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_REF_PROTECTED == "true"
    - when: manual
      allow_failure: true

build-docker-frontend:
  extends: .docker-build-base
  script:
    - mvn $MAVEN_CLI_OPTS package jib:build -DskipTests
      -pl sa-app-frontend
      -Djib.to.image=$CI_REGISTRY_IMAGE/frontend:$CI_COMMIT_SHA
      -Djib.to.auth.username=$CI_REGISTRY_USER
      -Djib.to.auth.password=$CI_REGISTRY_PASSWORD
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_REF_PROTECTED == "true"
    - when: manual
      allow_failure: true

container-scan-api:
  stage: package
  image: $TRIVY_IMAGE
  needs:
    - job: build-docker-api
      artifacts: false
  script:
    - trivy image --exit-code 1 --severity HIGH,CRITICAL $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  allow_failure: true

container-scan-frontend:
  stage: package
  image: $TRIVY_IMAGE
  needs:
    - job: build-docker-frontend
      artifacts: false
  script:
    - trivy image --exit-code 1 --severity HIGH,CRITICAL $CI_REGISTRY_IMAGE/frontend:$CI_COMMIT_SHA
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  allow_failure: true